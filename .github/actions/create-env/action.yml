name: Create Environment
description: Installs the necessary dependencies and builds River

inputs:
  python:
    default: '3.9' # Used for branches

runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v3

    - name: set up rust
      if: runner.os != 'Linux'
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly
        override: true

    - run: curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain=nightly --profile=minimal -y && rustup show
      if: runner.os == 'Linux'
      shell: bash

    - name: Set up Python ${{ inputs.python }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ inputs.python }}

    - name: Cache the Python environment
      uses: actions/cache@v3
      id: cache-venv
      with:
        path: |
          ~/.venv
        key: ${{ runner.os }}-${{ inputs.python }}-venv-${{ hashFiles('**/setup.py') }}
        restore-keys: |
          ${{ github.run_id }}-venv-${{ runner.os }}-${{ inputs.python }}
          ${{ runner.os }}-${{ inputs.python }}-venv-

    - name: Install Python dependencies
      if: ${{ steps.cache-venv.outputs.cache-hit != 'true' }}
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python -m venv ~/.venv
        source ~/.venv/bin/activate
        pip install wheel
        pip install scikit-learn sqlalchemy
        pip install pytest-xdist[psutil]
        pip install numpydoc jupyter
        pip install git+https://github.com/MaxHalford/yamp

    - name: Build River
      shell: bash
      run: |
        source ~/.venv/bin/activate
        pip install -e ".[dev,docs]"

    - uses: actions/cache/save@v3
      id: cache-river
      with:
        path: ${{ github.workspace }}
        key: river-build-${{ github.run_id }}-${{ runner.os }}-${{ inputs.python }}